# 图片水印工具 PRD

## 1. 项目概述

### 1.1 项目名称
图片水印工具 (Photo Watermark Tool)

### 1.2 项目描述
一个基于Python的命令行程序，用于为图片添加基于EXIF拍摄时间信息的水印。程序能够批量处理指定目录下的图片文件，提取拍摄时间信息作为水印文本，并支持自定义水印样式和位置。

### 1.3 目标用户
- 摄影师
- 图片处理爱好者
- 需要为图片添加时间标识的用户

## 2. 功能需求

### 2.1 核心功能

#### 2.1.1 图片路径输入
- **功能描述**：用户通过命令行参数或交互式输入指定图片文件路径
- **输入方式**：
  - 命令行参数：`python watermark.py --input /path/to/images`
  - 交互式输入：程序运行时提示用户输入路径
- **支持格式**：JPEG、PNG、TIFF等常见图片格式
- **路径验证**：检查路径是否存在，是否为有效目录

#### 2.1.2 EXIF信息提取
- **功能描述**：从图片的EXIF数据中提取拍摄时间信息
- **提取字段**：
  - 拍摄日期时间（DateTime）
  - 创建日期时间（DateTimeOriginal）
  - 数字化日期时间（DateTimeDigitized）
- **时间格式**：提取年月日信息，格式化为"YYYY-MM-DD"
- **异常处理**：当EXIF信息不存在时，使用文件修改时间作为备选

#### 2.1.3 水印文本生成
- **文本内容**：基于EXIF拍摄时间生成水印文本
- **格式示例**：
  - "2024-01-15"
  - "2023-12-25"
- **多图片处理**：批量处理目录下所有支持的图片文件

### 2.2 水印样式配置

#### 2.2.1 字体大小设置
- **参数名称**：`--font-size` 或 `-s`
- **默认值**：24
- **取值范围**：8-200
- **单位**：像素
- **示例**：`--font-size 32`

#### 2.2.2 颜色设置
- **参数名称**：`--color` 或 `-c`
- **支持格式**：
  - 颜色名称：red, blue, green, black, white等
  - RGB值：rgb(255,0,0)
  - 十六进制：#FF0000
- **默认值**：白色 (white)
- **示例**：`--color red` 或 `--color #FFFFFF`

#### 2.2.3 位置设置
- **参数名称**：`--position` 或 `-p`
- **支持位置**：
  - `top-left`：左上角
  - `top-right`：右上角
  - `bottom-left`：左下角
  - `bottom-right`：右下角
  - `center`：居中
  - `top-center`：顶部居中
  - `bottom-center`：底部居中
- **默认值**：`bottom-right`
- **示例**：`--position top-left`

#### 2.2.4 透明度设置
- **参数名称**：`--opacity` 或 `-o`
- **取值范围**：0.0-1.0
- **默认值**：0.8
- **示例**：`--opacity 0.5`

### 2.3 输出功能

#### 2.3.1 输出目录
- **目录命名规则**：`{原目录名}_watermark`
- **位置**：作为原目录的子目录
- **示例**：
  - 原目录：`/photos/vacation`
  - 输出目录：`/photos/vacation/vacation_watermark`

#### 2.3.2 文件命名
- **命名规则**：`{原文件名}_watermark.{扩展名}`
- **示例**：
  - 原文件：`IMG_001.jpg`
  - 输出文件：`IMG_001_watermark.jpg`

#### 2.3.3 目录创建
- **自动创建**：如果输出目录不存在，自动创建
- **权限检查**：确保有写入权限

## 3. 技术需求

### 3.1 开发环境
- **编程语言**：Python 3.7+
- **主要依赖库**：
  - `Pillow (PIL)`：图片处理
  - `exifread`：EXIF信息读取
  - `argparse`：命令行参数解析
  - `os`、`pathlib`：文件系统操作

### 3.2 性能要求
- **处理速度**：单张图片处理时间 < 2秒
- **内存使用**：处理大图片时内存占用 < 500MB
- **并发处理**：支持批量处理，但单线程执行

### 3.3 兼容性要求
- **操作系统**：Windows、macOS、Linux
- **Python版本**：3.7及以上
- **图片格式**：JPEG、PNG、TIFF、BMP

## 4. 用户界面

### 4.1 命令行界面
```
用法: watermark.py [-h] --input INPUT [--font-size FONT_SIZE] 
                   [--color COLOR] [--position POSITION] 
                   [--opacity OPACITY] [--output OUTPUT]

图片水印工具

可选参数:
  -h, --help            显示帮助信息
  --input INPUT, -i     输入图片目录路径
  --font-size FONT_SIZE, -s
                        字体大小 (默认: 24)
  --color COLOR, -c     水印颜色 (默认: white)
  --position POSITION, -p
                        水印位置 (默认: bottom-right)
  --opacity OPACITY, -o 透明度 (默认: 0.8)
  --output OUTPUT, -o   输出目录 (可选，默认自动生成)
```

### 4.2 交互式界面
当用户不提供命令行参数时，程序进入交互式模式：
```
欢迎使用图片水印工具！

请输入图片目录路径: /path/to/images
请输入字体大小 (默认24): 32
请输入水印颜色 (默认white): red
请输入水印位置 (默认bottom-right): top-left
请输入透明度 (默认0.8): 0.6

开始处理...
处理完成！输出目录: /path/to/images/images_watermark
```

## 5. 错误处理

### 5.1 输入验证
- **路径检查**：验证输入路径是否存在
- **权限检查**：验证读取和写入权限
- **格式检查**：验证图片文件格式是否支持

### 5.2 异常处理
- **EXIF读取失败**：使用文件修改时间作为备选
- **图片处理失败**：跳过问题文件，记录错误日志
- **输出失败**：提供详细的错误信息

### 5.3 日志记录
- **处理进度**：显示当前处理的文件
- **错误信息**：记录处理失败的文件和原因
- **统计信息**：显示成功/失败的文件数量

## 6. 测试需求

### 6.1 功能测试
- **基本功能**：测试各种参数组合
- **边界测试**：测试极端参数值
- **异常测试**：测试错误输入的处理

### 6.2 性能测试
- **批量处理**：测试大量文件的处理性能
- **大文件处理**：测试大尺寸图片的处理
- **内存使用**：监控内存占用情况

### 6.3 兼容性测试
- **多平台测试**：在不同操作系统上测试
- **格式测试**：测试各种图片格式的支持
- **Python版本测试**：在不同Python版本上测试

## 7. 交付物

### 7.1 源代码
- `watermark.py`：主程序文件
- `requirements.txt`：依赖包列表
- `README.md`：使用说明文档

### 7.2 文档
- **用户手册**：详细的使用说明
- **开发文档**：代码结构和API说明
- **测试报告**：功能测试和性能测试结果

### 7.3 示例
- **示例图片**：用于测试的示例图片
- **配置示例**：各种参数配置的示例
- **使用示例**：命令行使用示例
